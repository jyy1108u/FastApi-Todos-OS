<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>To-Do List</title>
  <style>
    :root {
      --bg: #f6f8fb;
      --panel: #ffffff;
      --card: #eef2ff;
      --card-done: #e7f6ef;
      --accent: #6b7cff;
      --accent-2: #f28ba8;
      --text: #1f2d3d;
      --muted: #6b7280;
      --border: #dfe4f2;
      --shadow: 0 10px 30px rgba(60,72,97,0.12);
      --shadow-hover: 0 16px 36px rgba(60,72,97,0.16);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: linear-gradient(180deg, #f7f9ff 0%, #f3f7ff 45%, #f7fbf9 100%);
      color: var(--text);
      font-family: "Segoe UI", "Pretendard", "Inter", system-ui, -apple-system, sans-serif;
    }
    .page { max-width: 1100px; margin: 32px auto 40px; padding: 0 20px; }
    .header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 18px; }
    h1 { margin: 0; font-size: 28px; letter-spacing: -0.3px; }
    .badge { background: #fff; border: 1px solid var(--border); border-radius: 999px; padding: 6px 12px; font-size: 13px; color: var(--muted); box-shadow: var(--shadow); }
    .layout { display: flex; gap: 18px; align-items: flex-start; }
    .main { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 14px; }
    .sidebar { width: 300px; position: sticky; top: 18px; }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 14px 16px; box-shadow: var(--shadow); }
    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px; }
    .toolbar input, .toolbar select {
      padding: 10px 12px; border-radius: 12px; border: 1px solid var(--border);
      background: #fff; min-width: 180px; outline: none;
    }
    .toolbar button, .form button {
      padding: 10px 14px; border-radius: 12px; border: none; cursor: pointer;
      font-weight: 600; color: #fff; background: var(--accent); box-shadow: var(--shadow);
    }
    .toolbar button:hover, .form button:hover { box-shadow: var(--shadow-hover); transform: translateY(-1px); }
    .list { list-style: none; padding: 0; margin: 0; display: grid; gap: 12px; }
    .todo-card {
      display: flex; align-items: flex-start; gap: 12px;
      padding: 14px 16px; border-radius: 14px; background: var(--card);
      border: 1px solid var(--border); box-shadow: var(--shadow);
      transition: transform 120ms ease, box-shadow 120ms ease, background 150ms ease;
    }
    .todo-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }
    .todo-card.done { background: var(--card-done); opacity: 0.96; }
    .title { font-weight: 700; margin-bottom: 4px; }
    .desc { color: var(--muted); font-size: 14px; }
    .actions { margin-left: auto; display: flex; gap: 8px; }
    .pill { font-size: 12px; padding: 2px 8px; border: 1px solid var(--border); border-radius: 999px; background: #fff; color: var(--muted); }
    .btn {
      border: none; border-radius: 10px; padding: 8px 10px; cursor: pointer; font-weight: 600;
      color: #0f172a; background: #fff; border: 1px solid var(--border); box-shadow: var(--shadow);
    }
    .btn:hover { box-shadow: var(--shadow-hover); }
    .btn.done { background: #cdeee1; color: #0f5132; }
    .btn.delete { background: var(--accent-2); color: #fff; border: none; }
    .form { display: flex; gap: 8px; flex-wrap: wrap; }
    .form input { flex: 1; min-width: 200px; padding: 12px; border-radius: 12px; border: 1px solid var(--border); }
    .muted { color: var(--muted); }
    /* Calendar */
    .calendar { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 14px; box-shadow: var(--shadow); }
    .cal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .cal-title { font-weight: 700; }
    .cal-nav { display: flex; gap: 6px; }
    .cal-nav button { padding: 6px 10px; cursor: pointer; border-radius: 10px; border: 1px solid var(--border); background: #fff; }
    .cal-weekdays, .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .cal-weekdays { font-size: 12px; color: #888; margin-bottom: 6px; text-align: center; }
    .cal-day { text-align: center; padding: 10px 0; border-radius: 10px; cursor: pointer; user-select: none; background: #f4f6fb; border: 1px solid transparent; }
    .cal-day:hover { background: #e7ecff; }
    .cal-day.dim { color: #bbb; cursor: default; background: transparent; border: none; }
    .cal-today { outline: 2px solid var(--accent); background: #eef3ff; }
    .panel-title { font-weight: 700; margin: 0 0 6px; display: flex; align-items: center; gap: 6px; }
    .mini-list { list-style: none; padding: 0; margin: 8px 0 0; display: flex; flex-direction: column; gap: 8px; }
    .mini-item { padding: 10px 12px; border-radius: 12px; background: #f5f7ff; border: 1px solid var(--border); font-size: 14px; display: flex; justify-content: space-between; gap: 8px; }
    .mini-empty { color: var(--muted); font-size: 13px; padding: 6px 0 0; }
    .mini-pill { font-size: 12px; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); background: #fff; color: var(--muted); }
    .memo-area { width: 100%; border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; font-size: 14px; resize: vertical; min-height: 70px; }
    .memo-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
    .memo-save { background: var(--accent); color: #fff; border: none; border-radius: 12px; padding: 8px 12px; cursor: pointer; box-shadow: var(--shadow); font-weight: 600; }
    .memo-save:hover { box-shadow: var(--shadow-hover); transform: translateY(-1px); }
    .pill-alt { background: #e7f6ef; color: #0f5132; border: none; }
    .link-like { border: none; background: transparent; color: var(--accent); cursor: pointer; padding: 0; font-weight: 600; }
    @media (max-width: 900px) { .layout { flex-direction: column; } .sidebar { width: auto; position: static; } }
  </style>
</head>
<body>
  <div class="page">
    <div class="header">
      <h1>To-Do List</h1>
      <span id="stats" class="badge">-</span>
    </div>

    <div class="layout">
      <div class="main">
        <div class="panel">
          <div class="toolbar">
            <input type="search" id="search" placeholder="검색(제목/설명)" />
            <select id="filter">
              <option value="">전체</option>
              <option value="false">미완료</option>
              <option value="true">완료</option>
            </select>
            <button id="refresh" type="button">새로고침</button>
          </div>
          <ul id="todo-list" class="list"></ul>
        </div>

        <div class="panel">
          <form id="todo-form" class="form">
            <input type="text" id="title" placeholder="Title" required />
            <input type="text" id="description" placeholder="Description" required />
            <button type="submit">Add To-Do</button>
          </form>
        </div>
      </div>

      <aside class="sidebar">
        <div class="calendar" aria-label="달력">
          <div class="cal-header">
            <div class="cal-title" id="cal-title">-</div>
            <div class="cal-nav">
              <button type="button" id="cal-prev" title="이전 달">‹</button>
              <button type="button" id="cal-next" title="다음 달">›</button>
            </div>
          </div>
          <div class="cal-weekdays">
            <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
          </div>
          <div class="cal-grid" id="cal-grid"></div>
        </div>

        <div class="panel">
          <div class="panel-title">선택 날짜 할 일</div>
          <div class="muted" id="day-label">달력에서 날짜를 고르면 해당 날짜가 설명에 포함된 항목이 보여집니다.</div>
          <ul class="mini-list" id="day-list"></ul>
          <div style="margin-top:8px;">
            <button class="link-like" type="button" id="day-reset">선택 초기화</button>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">오늘의 메모</div>
          <textarea id="daily-memo" class="memo-area" placeholder="오늘의 한 줄 메모를 남겨보세요"></textarea>
          <div class="memo-actions">
            <span class="muted" id="memo-status">자동 저장되지 않으니 저장 버튼을 눌러 주세요.</span>
            <button type="button" class="memo-save" id="memo-save">저장</button>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">다가오는 일정</div>
          <div class="muted" style="font-size:13px;">설명에 포함된 날짜(YYYY-MM-DD)를 기준으로 가까운 순으로 표시합니다.</div>
          <ul class="mini-list" id="upcoming-list"></ul>
        </div>
      </aside>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const qs = () => {
      const q = $('#search').value.trim();
      const completed = $('#filter').value;
      const p = new URLSearchParams();
      if (q) p.set('q', q);
      if (completed !== '') p.set('completed', completed);
      return p.toString() ? `?${p.toString()}` : '';
    };

    async function fetchStats() {
      try {
        const res = await fetch('/todos/_stats');
        if (!res.ok) throw new Error();
        const s = await res.json();
        $('#stats').textContent = `총 ${s.total} · 완료 ${s.completed} · 대기 ${s.pending}`;
      } catch {
        $('#stats').textContent = '-';
      }
    }

    async function fetchTodos() {
      const todoList = $('#todo-list');
      todoList.innerHTML = '<li class="muted">불러오는 중...</li>';
      try {
        const res = await fetch(`/todos${qs()}`);
        if (!res.ok) throw new Error();
        const todos = await res.json();
        window.__todosCache = todos;
        todoList.innerHTML = '';
        if (!todos.length) {
          todoList.innerHTML = '<li class="muted">항목 없음</li>';
          renderDaySection();
          renderUpcoming();
          return;
        }
        for (const todo of todos) {
          const li = document.createElement('li');
          li.className = 'todo-card' + (todo.completed ? ' done' : '');

          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = !!todo.completed;
          cb.title = '완료 토글';

          const textWrap = document.createElement('div');
          const title = document.createElement('div');
          const desc = document.createElement('div');
          title.className = 'title';
          desc.className = 'desc';
          title.textContent = todo.title;
          desc.textContent = todo.description || '';
          textWrap.appendChild(title);
          textWrap.appendChild(desc);

          const actions = document.createElement('div');
          actions.className = 'actions';
          const doneBtn = document.createElement('button');
          doneBtn.className = 'btn done';
          doneBtn.textContent = todo.completed ? '되돌리기' : '완료';
          const del = document.createElement('button');
          del.className = 'btn delete';
          del.textContent = '삭제';

          const applyStyle = () => {
            li.classList.toggle('done', cb.checked);
            title.style.textDecoration = cb.checked ? 'line-through' : 'none';
            title.style.color = cb.checked ? '#6b7280' : '#111827';
            doneBtn.textContent = cb.checked ? '되돌리기' : '완료';
          };
          applyStyle();

          const updateCompleted = async (state) => {
            try {
              const r = await fetch(`/todos/${todo.id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ completed: state })
              });
              if (!r.ok) throw new Error();
              cb.checked = state;
              applyStyle();
              await fetchStats();
            } catch {
              alert('완료 상태 업데이트 실패');
            }
          };

          cb.addEventListener('change', () => updateCompleted(cb.checked));
          doneBtn.addEventListener('click', () => updateCompleted(!cb.checked));

          del.addEventListener('click', async () => {
            if (!confirm('삭제할까요?')) return;
            try {
              const r = await fetch(`/todos/${todo.id}`, { method: 'DELETE' });
              if (!r.ok) throw new Error();
              await Promise.all([fetchStats(), fetchTodos()]);
            } catch {
              alert('삭제 실패');
            }
          });

          actions.appendChild(doneBtn);
          actions.appendChild(del);

          li.appendChild(cb);
          li.appendChild(textWrap);
          li.appendChild(actions);
          todoList.appendChild(li);
        }
        renderDaySection();
        renderUpcoming();
      } catch {
        todoList.innerHTML = '<li class="muted">불러오기 실패</li>';
      }
    }

    $('#todo-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = $('#title').value.trim();
      const description = $('#description').value.trim();
      if (!title || !description) return;

      try {
        const res = await fetch('/todos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: Date.now(), title, description, completed: false })
        });
        if (!res.ok) throw new Error();
        $('#title').value = '';
        $('#description').value = '';
        await Promise.all([fetchStats(), fetchTodos()]);
      } catch {
        alert('추가 실패');
      }
    });

    let searchTimer = null;
    $('#search').addEventListener('input', () => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(fetchTodos, 250);
    });
    $('#filter').addEventListener('change', fetchTodos);
    $('#refresh').addEventListener('click', () => { fetchStats(); fetchTodos(); });

    fetchStats();
    fetchTodos();

    const calTitle = document.getElementById('cal-title');
    const calGrid = document.getElementById('cal-grid');
    const calPrev = document.getElementById('cal-prev');
    const calNext = document.getElementById('cal-next');
    const dayLabel = document.getElementById('day-label');
    const dayList = document.getElementById('day-list');
    const dayReset = document.getElementById('day-reset');
    const memoField = document.getElementById('daily-memo');
    const memoSave = document.getElementById('memo-save');
    const memoStatus = document.getElementById('memo-status');
    const upcomingList = document.getElementById('upcoming-list');

    let calYear, calMonth;
    let selectedDate = null;
    const memoKey = 'todo-daily-memo';

    const zero = (n) => String(n).padStart(2, '0');
    const formatDate = (y, m, d) => `${y}-${zero(m)}-${zero(d)}`;

    function firstDayIndexMondayFirst(y, m) {
      const jsIdx = new Date(y, m - 1, 1).getDay();
      return (jsIdx + 6) % 7;
    }

    function daysInMonth(y, m) { return new Date(y, m, 0).getDate(); }
    function todayTriple() { const t = new Date(); return [t.getFullYear(), t.getMonth() + 1, t.getDate()]; }
    function todayStr() { const [y, m, d] = todayTriple(); return formatDate(y, m, d); }
    function extractDate(desc = '') {
      const m = desc.match(/(\\d{4}-\\d{2}-\\d{2})/);
      return m ? m[1] : null;
    }
    function asDate(str) {
      const parts = str.split('-').map(Number);
      if (parts.length !== 3) return null;
      return new Date(parts[0], parts[1] - 1, parts[2]);
    }

    function renderCalendar(y, m) {
      calYear = y; calMonth = m;
      calTitle.textContent = `${y}-${zero(m)}`;
      calGrid.innerHTML = '';

      const lead = firstDayIndexMondayFirst(y, m);
      const count = daysInMonth(y, m);
      const [ty, tm, td] = todayTriple();

      for (let i = 0; i < lead; i++) {
        const cell = document.createElement('div');
        cell.className = 'cal-day dim';
        calGrid.appendChild(cell);
      }
      for (let d = 1; d <= count; d++) {
        const cell = document.createElement('div');
        cell.className = 'cal-day';
        cell.textContent = d;
        if (y === ty && m === tm && d === td) cell.classList.add('cal-today');
        cell.addEventListener('click', () => {
          const desc = document.getElementById('description');
          const stamp = formatDate(y, m, d);
          selectedDate = stamp;
          renderDaySection();
          if (!desc.value.trim()) {
            desc.value = stamp;
          } else if (!desc.value.includes(stamp)) {
            desc.value = `${desc.value.trim()} ${stamp}`;
          }
          desc.focus();
        });
        calGrid.appendChild(cell);
      }
    }

    function renderDaySection() {
      const todos = window.__todosCache || [];
      const target = selectedDate || todayStr();
      dayLabel.textContent = selectedDate
        ? `선택 날짜: ${target}`
        : `오늘(${target}) 기준으로 설명에 날짜가 포함된 항목만 보여줍니다.`;
      dayList.innerHTML = '';
      const filtered = todos.filter(t => (t.description || '').includes(target));
      if (!filtered.length) {
        dayList.innerHTML = '<li class="mini-empty">해당 날짜와 매칭되는 항목이 없습니다.</li>';
        return;
      }
      for (const t of filtered) {
        const li = document.createElement('li');
        li.className = 'mini-item';
        li.innerHTML = `
          <span>${t.title}</span>
          <span class="mini-pill">${t.completed ? '완료' : '대기'}</span>
        `;
        dayList.appendChild(li);
      }
    }

    function renderUpcoming() {
      const todos = window.__todosCache || [];
      const base = asDate(todayStr());
      const upcoming = [];
      for (const t of todos) {
        const dstr = extractDate(t.description || '');
        if (!dstr) continue;
        const dt = asDate(dstr);
        if (!dt || dt < base) continue;
        upcoming.push({ todo: t, dstr, dt });
      }
      upcoming.sort((a, b) => a.dt - b.dt);
      const shortList = upcoming.slice(0, 5);
      upcomingList.innerHTML = '';
      if (!shortList.length) {
        upcomingList.innerHTML = '<li class="mini-empty">예정된 일정이 없습니다.</li>';
        return;
      }
      for (const item of shortList) {
        const li = document.createElement('li');
        li.className = 'mini-item';
        const dueSoon = (item.dt - base) / (1000 * 60 * 60 * 24) <= 3;
        const pillClass = dueSoon ? 'mini-pill pill-alt' : 'mini-pill';
        li.innerHTML = `
          <div>
            <div style="font-weight:700;">${item.todo.title}</div>
            <div class="muted" style="font-size:12px;">${item.todo.description || ''}</div>
          </div>
          <span class="${pillClass}">${item.dstr}</span>
        `;
        upcomingList.appendChild(li);
      }
    }

    function initMemo() {
      memoField.value = localStorage.getItem(memoKey) || '';
      memoSave.addEventListener('click', () => {
        localStorage.setItem(memoKey, memoField.value);
        memoStatus.textContent = '저장됨';
        memoStatus.style.color = '#0f5132';
        setTimeout(() => { memoStatus.textContent = '자동 저장되지 않으니 저장 버튼을 눌러 주세요.'; memoStatus.style.color = ''; }, 2000);
      });
    }

    (function initCalendar() {
      const t = new Date();
      renderCalendar(t.getFullYear(), t.getMonth() + 1);
    })();

    calPrev.addEventListener('click', () => {
      let y = calYear, m = calMonth - 1;
      if (m === 0) { y -= 1; m = 12; }
      renderCalendar(y, m);
    });
    calNext.addEventListener('click', () => {
      let y = calYear, m = calMonth + 1;
      if (m === 13) { y += 1; m = 1; }
      renderCalendar(y, m);
    });
    dayReset.addEventListener('click', () => { selectedDate = null; renderDaySection(); });
    initMemo();
    renderDaySection();
    renderUpcoming();
  </script>
</body>
</html>
